---
import { SEO } from "astro-seo";
import "uno.css";
import siteConfig from "../side.config";

export interface Props {
  title?: string;
  description?: string;
  image?: string;
}

const { title, description, image } = Astro.props;

// SEO-related variables
const seoTitle = title ? `${title} | ${siteConfig.title}` : siteConfig.title;
const seoDesc = description || siteConfig.description;
// Assumes a default OG image is specified in siteConfig, with a fallback.
const ogImage = image || "/profile.svg";

const currentYear = new Date().getFullYear();
const siteTitle = siteConfig.author || siteConfig.title;
const navLinks = siteConfig.navLinks;
const inlineLinkClasses =
  "block px-3 py-2 text-center font-medium text-slate-600 no-underline transition-colors duration-200 hover:bg-accent-100 hover:text-accent-700 dark:text-slate-300 dark:hover:bg-accent-500/20 dark:hover:text-accent-200 rounded-full";
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href={siteConfig.favicon} />

    <meta name="keywords" content={siteConfig.keywords.join(", ")} />
    <meta name="generator" content={Astro.generator} />
    <title>{siteConfig.title}</title>
    <link rel="sitemap" href="/sitemap-index.xml" />

    <SEO
      title={seoTitle}
      description={seoDesc}
      openGraph={{
        basic: {
          title: seoTitle,
          type: "website",
          image: ogImage,
        },
      }}
      extend={{
        link: [{ rel: "icon", href: siteConfig.favicon }],
        meta: [{ name: "keywords", content: siteConfig.keywords.join(", ") }],
      }}
    />
    <slot name="head" />
  </head>
  <body
    class="min-h-screen bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-sans transition-colors duration-300"
  >
    <div
      class="mx-auto flex min-h-screen max-w-4xl flex-col px-4 sm:px-6 md:px-8"
    >
      <header class="relative flex items-center justify-between py-4 sm:py-6">
        <a
          data-site-title
          class="font-heading text-xl font-bold tracking-tight no-underline text-gray-900 dark:text-gray-100 transition-transform duration-200 active:scale-95"
          href="/"
        >
          {siteTitle}
        </a>

        <!-- Desktop Navigation & Actions -->
        <div class="hidden sm:flex sm:items-center sm:gap-4">
          <nav>
            <ul class="m-0 flex list-none items-center gap-1 p-0">
              {
                navLinks.map((link) => (
                  <li>
                    <a
                      class="block px-3 py-1.5 text-sm font-medium text-gray-600 no-underline transition-all hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-100 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800"
                      href={link.href}
                    >
                      {link.label}
                    </a>
                  </li>
                ))
              }
            </ul>
          </nav>
          <button
            type="button"
            data-theme-toggle
            class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-white border border-gray-200 shadow-sketch transition-all hover:shadow-sketch-hover hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 text-gray-600 cursor-pointer"
            aria-label="Toggle color mode"
          >
            <span class="sr-only">Toggle color mode</span>
            <span
              class="i-ph-moon-stars-duotone block text-lg dark:hidden"
              aria-hidden="true"></span>
            <span
              class="i-ph-sun-dim-duotone hidden text-lg dark:block"
              aria-hidden="true"></span>
          </button>
        </div>

        <!-- Mobile Menu Button -->
        <button
          type="button"
          id="mobile-menu-toggle"
          class="sm:hidden inline-flex h-8 w-8 items-center justify-center rounded-full bg-white border border-gray-200 shadow-sketch transition-all hover:shadow-sketch-hover hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 text-gray-600 cursor-pointer z-50"
          aria-label="Toggle menu"
          aria-expanded="false"
        >
          <span class="sr-only">Toggle menu</span>
          <span
            id="icon-menu"
            class="i-ph-list-bold text-lg transition-transform duration-200"
          ></span>
          <span
            id="icon-close"
            class="i-ph-x-bold text-lg hidden transition-transform duration-200"
          ></span>
        </button>

        <!-- Mobile Dropdown Menu -->
        <div
          id="mobile-menu"
          class="absolute top-full right-0 z-40 mt-2 w-44 origin-top-right rounded-xl bg-white p-1.5 shadow-sketch ring-1 ring-gray-200 dark:bg-gray-800 dark:ring-gray-700 opacity-0 scale-95 invisible transition-all duration-200 transform"
        >
          <nav>
            <ul class="flex flex-col gap-0.5 list-none p-0 m-0">
              {
                navLinks.map((link) => (
                  <li>
                    <a
                      class="block px-3 py-2 text-sm font-medium text-gray-600 no-underline transition-all hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-100 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800"
                      href={link.href}
                    >
                      {link.label}
                    </a>
                  </li>
                ))
              }
            </ul>
          </nav>
        </div>
      </header>

      <main class="flex-1 space-y-8 sm:space-y-10">
        <slot />
      </main>

      <footer
        class="mt-8 border-t border-gray-200 pt-6 text-xs text-gray-500 dark:border-gray-800 dark:text-gray-400 sm:mt-12 pb-8"
      >
        <p class="m-0 text-center">
          &copy; {
            `${currentYear} ${siteConfig.author}. ${siteConfig.footer.copyright}`
          }
        </p>
      </footer>
    </div>

    <!-- Mobile Floating Action Buttons -->
    <div class="fixed bottom-4 right-4 z-50 flex flex-col gap-2 sm:hidden">
      <button
        type="button"
        id="back-to-top"
        class="flex h-8 w-8 items-center justify-center rounded-full bg-white border border-gray-200 shadow-sketch transition-all hover:shadow-sketch-hover hover:scale-105 active:scale-95 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 text-gray-600 opacity-0 translate-y-4 pointer-events-none data-[visible=true]:opacity-100 data-[visible=true]:translate-y-0 data-[visible=true]:pointer-events-auto duration-300 cursor-pointer"
        aria-label="Back to top"
      >
        <span class="i-ph-arrow-up-bold text-base"></span>
      </button>

      <button
        type="button"
        data-theme-toggle
        class="flex h-8 w-8 items-center justify-center rounded-full bg-white border border-gray-200 shadow-sketch transition-all hover:shadow-sketch-hover hover:scale-105 active:scale-95 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 text-gray-600 cursor-pointer"
        aria-label="Toggle color mode"
      >
        <span class="sr-only">Toggle color mode</span>
        <span class="i-ph-moon-stars-duotone block text-base dark:hidden"
        ></span>
        <span class="i-ph-sun-dim-duotone hidden text-base dark:block"></span>
      </button>
    </div>

    <script is:inline>
      (() => {
        // --- Theme management ---
        const STORAGE_KEY = "site-theme";
        const getStored = () => {
          try {
            return localStorage.getItem(STORAGE_KEY);
          } catch (err) {
            return null;
          }
        };

        const applyTheme = (mode) => {
          if (mode === "dark") {
            document.documentElement.classList.add("dark");
          } else {
            document.documentElement.classList.remove("dark");
          }
        };

        const stored = getStored();
        if (stored) {
          applyTheme(stored);
        } else if (
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches
        ) {
          applyTheme("dark");
        }

        // --- Event Listeners ---
        document.addEventListener("DOMContentLoaded", () => {
          // Mobile menu functionality
          const menuBtn = document.getElementById("mobile-menu-toggle");
          const menu = document.getElementById("mobile-menu");
          const iconMenu = document.getElementById("icon-menu");
          const iconClose = document.getElementById("icon-close");

          if (menuBtn && menu && iconMenu && iconClose) {
            const toggleMenu = () => {
              const isExpanded =
                menuBtn.getAttribute("aria-expanded") === "true";
              if (isExpanded) {
                // Close
                menuBtn.setAttribute("aria-expanded", "false");
                menu.classList.add("opacity-0", "scale-95", "invisible");
                menu.classList.remove("opacity-100", "scale-100", "visible");
                iconMenu.classList.remove("hidden");
                iconClose.classList.add("hidden");
              } else {
                // Open
                menuBtn.setAttribute("aria-expanded", "true");
                menu.classList.remove("opacity-0", "scale-95", "invisible");
                menu.classList.add("opacity-100", "scale-100", "visible");
                iconMenu.classList.add("hidden");
                iconClose.classList.remove("hidden");
              }
            };

            menuBtn.addEventListener("click", (e) => {
              e.stopPropagation();
              toggleMenu();
            });

            // Close on click outside
            document.addEventListener("click", (e) => {
              const isExpanded =
                menuBtn.getAttribute("aria-expanded") === "true";
              if (
                isExpanded &&
                !menu.contains(e.target) &&
                !menuBtn.contains(e.target)
              ) {
                toggleMenu();
              }
            });
          }

          // Theme toggle buttons
          const toggleButtons = document.querySelectorAll(
            "[data-theme-toggle]",
          );
          toggleButtons.forEach((btn) => {
            btn.addEventListener("click", () => {
              const isDark = document.documentElement.classList.toggle("dark");
              try {
                localStorage.setItem(STORAGE_KEY, isDark ? "dark" : "light");
              } catch (err) {
                /* ignore */
              }
            });
          });

          // System theme change
          if (window.matchMedia) {
            window
              .matchMedia("(prefers-color-scheme: dark)")
              .addEventListener("change", (event) => {
                if (!getStored()) {
                  applyTheme(event.matches ? "dark" : "light");
                }
              });
          }

          // Back to top functionality
          const backToTopBtn = document.getElementById("back-to-top");
          if (backToTopBtn) {
            const toggleBackToTop = () => {
              if (window.scrollY > 300) {
                backToTopBtn.setAttribute("data-visible", "true");
              } else {
                backToTopBtn.setAttribute("data-visible", "false");
              }
            };

            window.addEventListener("scroll", toggleBackToTop);
            backToTopBtn.addEventListener("click", () => {
              window.scrollTo({ top: 0, behavior: "smooth" });
            });
          }
        });
      })();
    </script>
  </body>
</html>
