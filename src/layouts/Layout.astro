---
import { SEO } from "astro-seo";
import "uno.css";
import siteConfig from "../side.config";

export interface Props {
  title?: string;
  description?: string;
  image?: string;
}

const { title, description, image } = Astro.props;

// SEO-related variables
const seoTitle = title ? `${title} | ${siteConfig.title}` : siteConfig.title;
const seoDesc = description || siteConfig.description;
// Assumes a default OG image is specified in siteConfig, with a fallback.
const ogImage = image || "/profile.svg";

const currentYear = new Date().getFullYear();
const siteTitle = siteConfig.author || siteConfig.title;
const navLinks = siteConfig.navLinks;
const inlineLinkClasses =
	"block px-3 py-2 text-center font-medium text-slate-600 no-underline transition-colors duration-200 hover:bg-accent-100 hover:text-accent-700 dark:text-slate-300 dark:hover:bg-accent-500/20 dark:hover:text-accent-200 rounded-full";
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href={siteConfig.favicon} />
    <meta name="description" content={siteConfig.description} />
    <meta name="keywords" content={siteConfig.keywords.join(", ")} />
    <meta name="generator" content={Astro.generator} />
    <title>{siteConfig.title}</title>
    <link rel="sitemap" href="/sitemap-index.xml" />

    <SEO
      title={seoTitle}
      description={seoDesc}
      openGraph={{
        basic: {
          title: seoTitle,
          type: "website",
          image: ogImage,
        },
      }}
      extend={{
        link: [{ rel: "icon", href: siteConfig.favicon }],
        meta: [{ name: "keywords", content: siteConfig.keywords.join(", ") }],
      }}
    />
    <slot name="head" />
  </head>
  <body
    class="min-h-screen bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-sans transition-colors duration-300"
  >
    <div
      class="mx-auto flex min-h-screen max-w-5xl flex-col px-6 md:px-12"
    >
      <header
        class="flex flex-wrap items-center justify-between gap-y-4 py-6 md:py-10 md:flex-nowrap md:gap-x-8"
      >
        <a
          data-site-title
          class="font-heading text-2xl font-bold tracking-tight no-underline text-gray-900 dark:text-gray-100 md:order-1 transition-transform duration-200 active:scale-95"
          href="/"
        >
          {siteTitle}
        </a>
        <div data-actions class="flex items-center gap-3 md:order-3">
          <button
            type="button"
            data-theme-toggle
            class="hidden md:inline-flex h-8 w-8 items-center justify-center rounded-full bg-white border border-gray-200 shadow-sketch transition-all hover:shadow-sketch-hover hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 text-gray-600 cursor-pointer"
            aria-label="Toggle color mode"
          >
            <span class="sr-only">Toggle color mode</span>
            <span
              class="i-ph-moon-stars-duotone block text-lg dark:hidden"
              aria-hidden="true"></span>
            <span
              class="i-ph-sun-dim-duotone hidden text-lg dark:block"
              aria-hidden="true"></span>
          </button>
        </div>
        <nav
          class="order-last w-full md:order-2 md:flex-1 md:min-w-0 md:overflow-hidden"
        >
          <ul
            class="m-0 flex list-none flex-wrap items-center justify-center gap-2 p-0 md:justify-end"
          >
            {
              navLinks.map((link) => (
                <li>
                  <a class="block px-4 py-2 text-sm font-medium text-gray-600 no-underline transition-all hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-100 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800" href={link.href}>
                    {link.label}
                  </a>
                </li>
              ))
            }
          </ul>
        </nav>
      </header>

      <main class="flex-1 space-y-10 md:space-y-16">
        <slot />
      </main>

      <footer
        class="mt-12 border-t border-gray-200 pt-8 text-sm text-gray-600 dark:border-gray-800 dark:text-gray-400 md:mt-20 pb-10"
      >
        <p class="m-0 text-center">
          &copy; {
            `${currentYear} ${siteConfig.author}. ${siteConfig.footer.copyright}`
          }
        </p>
      </footer>
    </div>

    <!-- Mobile Floating Action Buttons -->
    <div class="fixed bottom-6 right-6 z-50 flex flex-col gap-3 md:hidden">
      <button
        type="button"
        id="back-to-top"
        class="flex h-8 w-8 items-center justify-center rounded-full bg-white border border-gray-200 shadow-sketch transition-all hover:shadow-sketch-hover hover:scale-105 active:scale-95 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 text-gray-600 opacity-0 translate-y-4 pointer-events-none data-[visible=true]:opacity-100 data-[visible=true]:translate-y-0 data-[visible=true]:pointer-events-auto duration-300 cursor-pointer"
        aria-label="Back to top"
      >
        <span class="i-ph-arrow-up-bold text-lg"></span>
      </button>
      
      <button
        type="button"
        data-theme-toggle
        class="flex h-8 w-8 items-center justify-center rounded-full bg-white border border-gray-200 shadow-sketch transition-all hover:shadow-sketch-hover hover:scale-105 active:scale-95 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 text-gray-600 cursor-pointer"
        aria-label="Toggle color mode"
      >
        <span class="sr-only">Toggle color mode</span>
        <span class="i-ph-moon-stars-duotone block text-lg dark:hidden"></span>
        <span class="i-ph-sun-dim-duotone hidden text-lg dark:block"></span>
      </button>
    </div>

    <script is:inline>
      (() => {
        // --- Theme management ---
        const STORAGE_KEY = "site-theme";
        const getStored = () => {
          try {
            return localStorage.getItem(STORAGE_KEY);
          } catch (err) {
            return null;
          }
        };

        const applyTheme = (mode) => {
          if (mode === "dark") {
            document.documentElement.classList.add("dark");
          } else {
            document.documentElement.classList.remove("dark");
          }
        };

        const stored = getStored();
        if (stored) {
          applyTheme(stored);
        } else if (
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches
        ) {
          applyTheme("dark");
        }

        // --- Event Listeners ---
        document.addEventListener("DOMContentLoaded", () => {
          // Theme toggle buttons
          const toggleButtons = document.querySelectorAll(
            "[data-theme-toggle]"
          );
          toggleButtons.forEach((btn) => {
            btn.addEventListener("click", () => {
              const isDark = document.documentElement.classList.toggle("dark");
              try {
                localStorage.setItem(STORAGE_KEY, isDark ? "dark" : "light");
              } catch (err) {
                /* ignore */
              }
            });
          });

          // System theme change
          if (window.matchMedia) {
            window
              .matchMedia("(prefers-color-scheme: dark)")
              .addEventListener("change", (event) => {
                if (!getStored()) {
                  applyTheme(event.matches ? "dark" : "light");
                }
              });
          }

          // Back to top functionality
          const backToTopBtn = document.getElementById("back-to-top");
          if (backToTopBtn) {
            const toggleBackToTop = () => {
              if (window.scrollY > 300) {
                backToTopBtn.setAttribute("data-visible", "true");
              } else {
                backToTopBtn.setAttribute("data-visible", "false");
              }
            };

            window.addEventListener("scroll", toggleBackToTop);
            backToTopBtn.addEventListener("click", () => {
              window.scrollTo({ top: 0, behavior: "smooth" });
            });
          }
        });
      })();
    </script>
  </body>
</html>
