---
import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";
import { getFeaturedPapers } from "../lib/papers";
import siteConfig from "../side.config";
import { Image } from "astro:assets";

const recentPosts = (await getCollection("posts"))
  .filter((post) => !post.data.draft)
  .sort(
    (a, b) =>
      new Date(b.data.publishedAt).getTime() -
      new Date(a.data.publishedAt).getTime(),
  )
  .slice(0, 3);

const selectedPapers = getFeaturedPapers(3);

const rawProfileImage = siteConfig.hero.profileImage.trim();
const profileImageUrl = /^https?:/i.test(rawProfileImage)
  ? rawProfileImage
  : rawProfileImage.startsWith("/")
    ? rawProfileImage
    : new URL(
        rawProfileImage.startsWith(".")
          ? rawProfileImage
          : `../${rawProfileImage}`,
        import.meta.url,
      ).href;

const about = {
  name: siteConfig.author,
  bio: siteConfig.hero.subheadline,
  avatar: profileImageUrl,
  socialLinks: siteConfig.socialLinks,
};

// Get affiliations and research interests from config
const affiliations = siteConfig.affiliations || [];
const researchInterests = siteConfig.researchInterests || [];
const statusBadge = siteConfig.hero.statusBadge;
---

<Layout title="Home">
  <!-- Hero Section -->
  <section class="relative">
    <div class="flex flex-col-reverse gap-6 sm:flex-row sm:items-start sm:justify-between sm:gap-8">
      <div class="flex-1 space-y-4">
        <!-- Name & Title -->
        <div class="space-y-2">
          <h1 class="font-heading text-3xl font-bold leading-tight text-gray-900 dark:text-gray-100 sm:text-4xl">
            {about.name}
          </h1>
          
          <!-- Affiliations -->
          {affiliations.length > 0 && (
            <div class="space-y-0.5">
              {affiliations.map((aff) => (
                <p class="text-base text-gray-600 dark:text-gray-400">
                  {aff.role}
                  {aff.department && <span>, {aff.department}</span>}
                  {aff.url ? (
                    <a 
                      href={aff.url} 
                      target="_blank" 
                      rel="noopener noreferrer"
                      class="text-accent-600 dark:text-accent-400 hover:underline no-underline"
                    >
                      @ {aff.institution}
                    </a>
                  ) : (
                    <span>, {aff.institution}</span>
                  )}
                </p>
              ))}
            </div>
          )}
          
          <!-- Status Badge -->
          {statusBadge && (
            <span class="inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium text-emerald-700 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-900/20 rounded-full border border-emerald-200 dark:border-emerald-800">
              {statusBadge}
            </span>
          )}
        </div>
        
        <!-- Bio -->
        <p class="text-sm leading-relaxed text-gray-700 dark:text-gray-300 max-w-2xl">
          {about.bio}
        </p>
        
        <!-- Research Interests -->
        {researchInterests.length > 0 && (
          <div class="flex flex-wrap gap-1.5">
            {researchInterests.map((interest) => (
              <span class="px-2 py-0.5 text-xs font-medium text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-800 rounded">
                {interest}
              </span>
            ))}
          </div>
        )}
        
        <!-- Social Links -->
        <div class="flex flex-wrap gap-2">
          {
            about.socialLinks.slice(0, 5).map((link) => (
              <a
                href={link.href}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center justify-center gap-1.5 rounded-full border border-gray-300 dark:border-gray-700 px-3 py-1.5 text-sm font-medium text-gray-700 dark:text-gray-300 transition-all hover:border-gray-400 hover:bg-gray-50 dark:hover:border-gray-600 dark:hover:bg-gray-800/50 no-underline"
                title={link.label}
              >
                <span class={`${link.icon} text-base`} />
                <span class="hidden sm:inline text-xs">{link.label}</span>
              </a>
            ))
          }
        </div>
      </div>
      
      <!-- Profile Image -->
      <div class="relative shrink-0 mx-auto sm:mx-0">
        <div 
          class="relative overflow-hidden rounded-xl shadow-md ring-2 ring-white dark:ring-gray-800"
          style={{ 
            width: `${siteConfig.hero.profileImageWidth || 160}px`, 
            height: `${siteConfig.hero.profileImageHeight || 160}px` 
          }}
        >
          <Image
            src={about.avatar}
            alt={about.name}
            width={siteConfig.hero.profileImageWidth || 160}
            height={siteConfig.hero.profileImageHeight || 160}
            class="h-full w-full object-cover"
            loading="eager"
            fetchpriority="high"
          />
        </div>
        <!-- Decorative element -->
        <div class="absolute -z-10 -bottom-1.5 -right-1.5 h-full w-full rounded-xl bg-accent-100 dark:bg-accent-900/30"></div>
      </div>
    </div>
  </section>

  <!-- Selected Publications Section -->
  <section class="fade-in-up animation-delay-200 space-y-3">
    <div class="flex items-baseline justify-between border-b border-gray-200 dark:border-gray-800 pb-2">
      <div class="space-y-0.5">
        <h2 class="font-heading text-xl font-bold text-gray-900 dark:text-gray-100">
          {siteConfig.homeBlocks.publications.title}
        </h2>
        {siteConfig.homeBlocks.publications.description && <p class="text-xs text-gray-500 dark:text-gray-500">{siteConfig.homeBlocks.publications.description}</p>}
      </div>
      <a
        href="/researches"
        class="text-xs font-medium text-accent-600 hover:text-accent-700 dark:text-accent-400 dark:hover:text-accent-300 no-underline flex items-center gap-1"
      >
        View all <span class="i-mdi:arrow-right text-sm"></span>
      </a>
    </div>
    <div class="flex flex-col gap-3">
      {
        selectedPapers.map((paper, index) => {
          const abstractId = `abstract-home-${paper.id}`;
          const hasAbstract = Boolean(paper.abstract);

          return (
            <article class="group relative p-6 rounded-2xl bg-white dark:bg-gray-800/50 shadow-sm hover:shadow-md transition-all duration-300">
              <!-- Accent line -->
              <div class="absolute left-0 top-4 bottom-4 w-1 rounded-full bg-gradient-to-b from-accent-400 to-accent-600 opacity-0 group-hover:opacity-100 transition-opacity"></div>
              
              <div class="space-y-2">
                <!-- Title -->
                <h3 class="font-bold text-gray-900 dark:text-gray-100 leading-snug">
                  {paper.url ? (
                    <a
                      href={paper.url}
                      target="_blank"
                      rel="noreferrer"
                      class="hover:text-accent-600 dark:hover:text-accent-400 transition-colors no-underline text-inherit inline-flex items-start gap-1"
                    >
                      {paper.title}
                      <span class="i-mdi:open-in-new text-xs text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity shrink-0 mt-1"></span>
                    </a>
                  ) : paper.title}
                </h3>
                
                <!-- Authors -->
                {paper.authors.length > 0 && (
                  <p class="text-xs text-gray-600 dark:text-gray-400 flex items-center gap-1.5">
                    <span class="i-mdi:account-group text-gray-400 dark:text-gray-500 shrink-0"></span>
                    {paper.authors.join(", ")}
                  </p>
                )}
                
                <!-- Meta info -->
                <div class="flex flex-wrap items-center gap-2">
                  {paper.venue && (
                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-md text-xs font-semibold text-accent-700 dark:text-accent-300 bg-accent-50 dark:bg-accent-900/40 border border-accent-200 dark:border-accent-800">
                      <span class="i-mdi:bookmark text-accent-500 text-xs"></span>
                      {paper.venue}
                    </span>
                  )}
                  {paper.year && (
                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-md text-xs font-medium text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-800">
                      <span class="i-mdi:calendar text-gray-400 dark:text-gray-500 text-xs"></span>
                      {paper.year}
                    </span>
                  )}
                </div>
                
                <!-- Action buttons -->
                <div class="flex flex-wrap items-center gap-1">
                  {hasAbstract && (
                    <button
                      class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-gray-600 dark:text-gray-400 hover:text-accent-600 dark:hover:text-accent-400 hover:bg-accent-50 dark:hover:bg-accent-900/30 rounded-md bg-transparent border-none cursor-pointer toggle-abstract transition-all"
                      type="button"
                      data-target={abstractId}
                      aria-controls={abstractId}
                      aria-expanded="false"
                    >
                      <span class="i-mdi:text-box-outline text-sm"></span>
                      Abstract
                    </button>
                  )}
                  {paper.url && (
                    <a 
                      href={paper.url}
                      target="_blank"
                      rel="noreferrer"
                      class="inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-gray-600 dark:text-gray-400 hover:text-accent-600 dark:hover:text-accent-400 hover:bg-accent-50 dark:hover:bg-accent-900/30 rounded-md no-underline transition-all"
                    >
                      <span class="i-mdi:file-pdf-box text-sm"></span>
                      PDF
                    </a>
                  )}
                </div>
              </div>

              {hasAbstract && (
                <div
                  class="hidden mt-3 p-3 text-xs leading-relaxed text-gray-600 dark:text-gray-400 bg-gradient-to-br from-gray-50 to-gray-100/50 dark:from-gray-800/50 dark:to-gray-800/30 rounded-lg border-l-3 border-accent-500"
                  id={abstractId}
                >
                  <div class="flex items-start gap-2">
                    <span class="i-mdi:format-quote-open text-base text-accent-400 shrink-0"></span>
                    <p class="flex-1">{paper.abstract}</p>
                  </div>
                </div>
              )}
            </article>
          );
        })
      }
    </div>
  </section>

  <!-- Recent Posts Section -->
  <section class="fade-in-up animation-delay-400 space-y-3">
    <div class="flex items-baseline justify-between border-b border-gray-200 dark:border-gray-800 pb-2">
      <div class="space-y-0.5">
        <h2 class="font-heading text-xl font-bold text-gray-900 dark:text-gray-100">
          {siteConfig.homeBlocks.posts.title}
        </h2>
        {siteConfig.homeBlocks.posts.description && <p class="text-xs text-gray-500 dark:text-gray-500">{siteConfig.homeBlocks.posts.description}</p>}
      </div>
      <a
        href="/posts"
        class="text-xs font-medium text-accent-600 hover:text-accent-700 dark:text-accent-400 dark:hover:text-accent-300 no-underline flex items-center gap-1"
      >
        View all <span class="i-mdi:arrow-right text-sm"></span>
      </a>
    </div>
    <div class="grid gap-3 sm:grid-cols-3">
      {
        recentPosts.map((post) => (
          <a href={`/posts/${post.slug}`} class="group block no-underline h-full">
            <article class="flex flex-col h-full p-6 rounded-2xl bg-white dark:bg-gray-800/50 shadow-sm hover:shadow-md transition-shadow duration-300">
              <time
                datetime={post.data.publishedAt.toISOString()}
                class="text-xs text-gray-500 dark:text-gray-500 font-mono mb-2"
              >
                {post.data.publishedAt.toLocaleDateString("en-US", {
                  year: "numeric",
                  month: "short",
                  day: "numeric",
                })}
              </time>
              
              <h3 class="text-sm font-bold text-gray-900 dark:text-gray-100 group-hover:text-accent-600 dark:group-hover:text-accent-400 transition-colors line-clamp-2 mb-2">
                {post.data.title}
              </h3>
              
              {post.data.description && (
                <p class="text-xs text-gray-600 dark:text-gray-400 line-clamp-3 leading-relaxed mb-auto">
                  {post.data.description}
                </p>
              )}
              
              <div class="flex items-center gap-1 text-xs font-medium text-accent-600 dark:text-accent-400 pt-3 mt-2 opacity-0 group-hover:opacity-100 transition-opacity">
                <span>Read more</span>
                <span class="i-mdi:arrow-right"></span>
              </div>
            </article>
          </a>
        ))
      }
    </div>
  </section>
</Layout><script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".toggle-abstract").forEach((toggle) => {
      toggle.addEventListener("click", () => {
        const targetId = toggle.getAttribute("data-target");
        if (!targetId) return;
        const abstract = document.getElementById(targetId);
        if (!abstract) return;

        abstract.classList.toggle("hidden");
        const isExpanded = toggle.getAttribute("aria-expanded") === "true";
        toggle.setAttribute("aria-expanded", (!isExpanded).toString());
      });
    });
  });
</script>
