---
import Layout from '../layouts/Layout.astro';
import { getAllPapers } from '../lib/papers';

const papers = getAllPapers();
const categoryOrder = ['Publication', 'Working Paper', 'Work in Progress', 'Other'] as const;
const grouped = new Map<string, typeof papers>();

for (const paper of papers) {
	const category = paper.category ?? 'Other';
	if (!grouped.has(category)) {
		grouped.set(category, []);
	}
	grouped.get(category)?.push(paper);
}

const orderedCategories = [
	...categoryOrder.filter((category) => grouped.has(category)),
	...Array.from(grouped.keys())
		.filter((category) => !categoryOrder.includes(category as (typeof categoryOrder)[number]))
		.sort((a, b) => a.localeCompare(b))
];
---

<Layout title="Researches">
  <div class="space-y-6">
    <header class="fade-in-up max-w-2xl">
      <h1 class="font-heading text-4xl font-bold text-[#111111] dark:text-[#f5f5f7] md:text-5xl">
        Researches
      </h1>
      <p class="mt-4 text-lg text-[#666666] dark:text-[#c4c7c5]">
        Peer-reviewed publications, workshop papers, and essays focusing on the flow of learning signals
        across scholarly and civic platforms.
      </p>
    </header>

    <div class="space-y-8">
      {orderedCategories.map((category) => {
        const categoryPapers = grouped.get(category);
        if (!categoryPapers?.length) {
          return null;
        }

        return (
          <section class="fade-in-up animation-delay-200 space-y-4">
            <h2 class="font-heading text-2xl font-bold text-[#111111] dark:text-[#f5f5f7]">
              {category}
            </h2>
            <div class="flex flex-col border-t border-gray-200 dark:border-gray-800">
              {categoryPapers.map((paper) => {
                const abstractId = `abstract-${paper.id}`;
                const hasAbstract = Boolean(paper.abstract);

                return (
                  <article class="group relative flex flex-col gap-1.5 border-b border-gray-200 dark:border-gray-800 py-3 hover:bg-gray-50 dark:hover:bg-gray-800/50 -mx-4 px-4 transition-colors">
                    <div class="flex flex-col gap-1.5">
                      <div class="flex flex-col gap-0">
                        <h3 class="text-lg font-bold text-[#111111] dark:text-[#f5f5f7] leading-snug font-heading">
                          {paper.url ? (
                            <a href={paper.url} target="_blank" rel="noreferrer" class="group-hover:text-accent-600 dark:group-hover:text-accent-400 transition-colors no-underline text-inherit">
                              {paper.title}
                            </a>
                          ) : (
                            paper.title
                          )}
                        </h3>
                        <div class="text-sm text-[#666666] dark:text-[#c4c7c5]">
                          {paper.authors.join(', ')}
                        </div>
                      </div>
                      <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-xs text-[#666666] dark:text-[#c4c7c5]">
                        <span class="font-medium text-[#111111] dark:text-[#f5f5f7] bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded">
                          {paper.venue ?? 'Venue pending'}
                        </span>
                        {paper.year && (
                          <>
                            <span>•</span>
                            <span>{paper.year}</span>
                          </>
                        )}
                        {hasAbstract && (
                          <>
                            <span>•</span>
                            <button
                              class="font-medium text-accent-600 dark:text-accent-400 hover:underline bg-transparent border-none p-0 cursor-pointer toggle-abstract"
                              type="button"
                              data-target={abstractId}
                              aria-controls={abstractId}
                              aria-expanded="false"
                            >
                              Abstract
                            </button>
                          </>
                        )}
                      </div>
                    </div>

                    {hasAbstract && (
                      <div class="hidden text-sm leading-relaxed text-[#666666] dark:text-[#c4c7c5] pl-4 border-l-2 border-accent-600/30 dark:border-accent-400/30 mt-1" id={abstractId}>
                        {paper.abstract}
                      </div>
                    )}
                  </article>
                );
              })}
            </div>
          </section>
        );
      })}
    </div>
  </div>
</Layout>

<script is:inline>
	document.addEventListener('DOMContentLoaded', () => {
		document.querySelectorAll('.toggle-abstract').forEach((toggle) => {
			toggle.addEventListener('click', () => {
				const targetId = toggle.getAttribute('data-target');
				if (!targetId) return;
				const abstract = document.getElementById(targetId);
				if (!abstract) return;

				abstract.classList.toggle('hidden');
				const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
				toggle.setAttribute('aria-expanded', (!isExpanded).toString());
			});
		});
	});
</script>
